<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>French A1 Chatbot</title>
  <style>
    body {font-family: Arial, sans-serif; margin:20px;}
    #chat {border:1px solid #ccc; padding:10px; width:350px; height:300px; overflow-y:auto; margin-bottom:10px;}
    .msg {margin:5px 0;}
    .bot {background:#f0f0f0; padding:5px; border-radius:5px;}
    .user {background:#d0f0ff; padding:5px; border-radius:5px; text-align:right;}
    #teacherPanel {border:1px solid #ccc; padding:10px; margin-top:10px; display:none;}
    .good {color:green;}
    .warn {color:orange;}
  </style>
</head>
<body>
  <h2>ðŸ¤– French A1 Chatbot</h2>
  <label>Choisis un thÃ¨me: 
    <select id="topic">
      <option value="intro">Introduction</option>
      <option value="famille">Famille</option>
      <option value="ecole">Ã‰cole</option>
      <option value="nourriture">Nourriture</option>
      <option value="loisirs">Loisirs</option>
      <option value="meteo">MÃ©tÃ©o</option>
    </select>
  </label>
  <button id="start">Commencer</button>
  <span id="turn">Tour: 0</span>
  
  <div id="chat"></div>
  
  <input id="userText" placeholder="Tape ta rÃ©ponse ici..." size="40">
  <button id="send">Envoyer</button>
  
  <div>
    <label><input type="checkbox" id="teacherMode"> Mode Professeur</label>
    <div id="extraTeacher" style="display:none; margin-top:5px;">
      <label><input type="checkbox" id="autoFb" checked> Feedback auto</label><br>
      <button id="downloadTxt">TÃ©lÃ©charger le transcript</button>
    </div>
  </div>
  
  <div id="teacherPanel">
    <h3>Transcript</h3>
    <div id="transcript"></div>
  </div>
  
<script>
/* --- Topics with keywords + model answers --- */
const topics = {
  intro: {steps:[
    {q:"Salut ! Comment tu tâ€™appelles ?", model:"Je mâ€™appelle Alex.", must:["m'appelle"]},
    {q:"Tu as quel Ã¢ge ?", model:"Jâ€™ai douze ans.", must:["j'ai","ans"]},
    {q:"Tu habites oÃ¹ ?", model:"Jâ€™habite Ã  Toronto.", must:["j'habite"]}
  ]},
  
  famille: {steps:[
    {q:"As-tu des frÃ¨res ou des sÅ“urs ?", model:"Oui, jâ€™ai un frÃ¨re et une sÅ“ur.", must:["frÃ¨re","sÅ“ur"]},
    {q:"Comment sâ€™appelle ton frÃ¨re ?", model:"Il sâ€™appelle Marc.", must:["il","s'appelle"]},
    {q:"Et ta sÅ“ur ?", model:"Elle sâ€™appelle Julie.", must:["elle","s'appelle"]}
  ]},

  ecole: {steps:[
    {q:"Tu es dans quelle classe ?", model:"Je suis en septiÃ¨me.", must:["je suis"]},
    {q:"Quelle est ta matiÃ¨re prÃ©fÃ©rÃ©e ?", model:"Ma matiÃ¨re prÃ©fÃ©rÃ©e est les mathÃ©matiques.", must:["ma matiÃ¨re prÃ©fÃ©rÃ©e"]},
    {q:"Comment est ton professeur de franÃ§ais ?", model:"Il est sympa.", must:["il est","elle est"]}
  ]},

  nourriture: {steps:[
    {q:"Quâ€™est-ce que tu aimes manger ?", model:"Jâ€™aime manger la pizza.", must:["j'aime","manger"]},
    {q:"Et quâ€™est-ce que tu nâ€™aimes pas ?", model:"Je nâ€™aime pas les champignons.", must:["je n'aime pas"]},
    {q:"Quâ€™est-ce que tu bois au petit-dÃ©jeuner ?", model:"Je bois du jus dâ€™orange.", must:["je bois"]}
  ]},

  loisirs: {steps:[
    {q:"Tu aimes le sport ?", model:"Oui, jâ€™aime le soccer.", must:["j'aime"]},
    {q:"Quel sport est ton prÃ©fÃ©rÃ© ?", model:"Mon sport prÃ©fÃ©rÃ© est le basketball.", must:["mon sport prÃ©fÃ©rÃ©"]},
    {q:"Quâ€™est-ce que tu fais le weekend ?", model:"Le weekend, je joue au foot et je regarde la tÃ©lÃ©.", must:["je","weekend"]}
  ]},

  meteo: {steps:[
    {q:"Quel temps fait-il aujourdâ€™hui ?", model:"Il fait beau.", must:["il fait"]},
    {q:"Et demain ?", model:"Demain, il va faire froid.", must:["il va faire"]},
    {q:"Quelle est ta saison prÃ©fÃ©rÃ©e ?", model:"Ma saison prÃ©fÃ©rÃ©e est lâ€™Ã©tÃ©.", must:["ma saison prÃ©fÃ©rÃ©e"]}
  ]}
};

let stepIndex=0, activeTopic="intro";
let transcript=[];

function el(id){return document.getElementById(id);}
function addMsg(text,who="bot"){
  const div=document.createElement("div");
  div.className="msg";
  const bubble=document.createElement("div");
  bubble.className=who;
  bubble.innerHTML=text;
  div.appendChild(bubble);
  el("chat").appendChild(div);
  el("chat").scrollTop=el("chat").scrollHeight;
}
function normalize(s){return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function checkAnswer(ans, step){
  const norm=normalize(ans);
  const must=step.must||[];
  if(must.length && must.every(k=>norm.includes(normalize(k)))){
    return "âœ… Bien !";
  } else if(must.length){
    let missing = must.filter(k=>!norm.includes(normalize(k)));
    return "ðŸŸ¡ Manque: Â« " + missing.join(", ") + " Â»<br>ðŸ’¡ Suggestion: " + step.model;
  }
  return "âšª RÃ©ponse reÃ§ue<br>ðŸ’¡ Suggestion: " + step.model;
}
function botAsk(){
  const step=topics[activeTopic].shuffled[stepIndex];
